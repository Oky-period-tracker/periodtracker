{"version":3,"sources":["../../../../src/export/embed/exportEmbedAsync.ts"],"sourcesContent":["/**\n * Copyright Â© 2023 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport { getConfig } from '@expo/config';\nimport fs from 'fs';\nimport { sync as globSync } from 'glob';\nimport Server from 'metro/src/Server';\nimport output from 'metro/src/shared/output/bundle';\nimport type { BundleOptions } from 'metro/src/shared/types';\nimport path from 'path';\n\nimport { Options } from './resolveOptions';\nimport { isExecutingFromXcodebuild, logMetroErrorInXcode } from './xcodeCompilerLogger';\nimport { Log } from '../../log';\nimport { loadMetroConfigAsync } from '../../start/server/metro/instantiateMetro';\nimport { getMetroDirectBundleOptionsForExpoConfig } from '../../start/server/middleware/metroOptions';\nimport { stripAnsi } from '../../utils/ansi';\nimport { removeAsync } from '../../utils/dir';\nimport { setNodeEnv } from '../../utils/nodeEnv';\nimport { profile } from '../../utils/profile';\nimport { isEnableHermesManaged } from '../exportHermes';\nimport { getAssets } from '../fork-bundleAsync';\nimport { persistMetroAssetsAsync } from '../persistMetroAssets';\n\nconst debug = require('debug')('expo:export:embed');\n\nfunction guessCopiedAppleBundlePath(bundleOutput: string) {\n  // Ensure the path is familiar before guessing.\n  if (!bundleOutput.match(/\\/Xcode\\/DerivedData\\/.*\\/Build\\/Products\\//)) {\n    debug('Bundling to non-standard location:', bundleOutput);\n    return false;\n  }\n  const bundleName = path.basename(bundleOutput);\n  const bundleParent = path.dirname(bundleOutput);\n  const possiblePath = globSync(path.join(bundleParent, `*.app/${bundleName}`), {\n    // bundle identifiers can start with dots.\n    dot: true,\n  })[0];\n  debug('Possible path for previous bundle:', possiblePath);\n  return possiblePath;\n}\n\nexport async function exportEmbedAsync(projectRoot: string, options: Options) {\n  setNodeEnv(options.dev ? 'development' : 'production');\n  require('@expo/env').load(projectRoot);\n\n  // Ensure we delete the old bundle to trigger a failure if the bundle cannot be created.\n  await removeAsync(options.bundleOutput);\n\n  // The iOS bundle is copied in to the Xcode project, so we need to remove the old one\n  // to prevent Xcode from loading the old one after a build failure.\n  if (options.platform === 'ios') {\n    const previousPath = guessCopiedAppleBundlePath(options.bundleOutput);\n    if (previousPath && fs.existsSync(previousPath)) {\n      debug('Removing previous iOS bundle:', previousPath);\n      await removeAsync(previousPath);\n    }\n  }\n\n  const { bundle, assets } = await exportEmbedBundleAndAssetsAsync(projectRoot, options);\n\n  fs.mkdirSync(path.dirname(options.bundleOutput), { recursive: true, mode: 0o755 });\n\n  // Persist bundle and source maps.\n  await Promise.all([\n    output.save(bundle, options, Log.log),\n    // NOTE(EvanBacon): This may need to be adjusted in the future if want to support baseUrl on native\n    // platforms when doing production embeds (unlikely).\n    options.assetsDest\n      ? persistMetroAssetsAsync(assets, {\n          platform: options.platform,\n          outputDirectory: options.assetsDest,\n          iosAssetCatalogDirectory: options.assetCatalogDest,\n        })\n      : null,\n  ]);\n}\n\nexport async function createMetroServerAndBundleRequestAsync(\n  projectRoot: string,\n  options: Pick<\n    Options,\n    | 'maxWorkers'\n    | 'config'\n    | 'platform'\n    | 'sourcemapOutput'\n    | 'sourcemapUseAbsolutePath'\n    | 'entryFile'\n    | 'minify'\n    | 'dev'\n    | 'unstableTransformProfile'\n  >\n): Promise<{ server: Server; bundleRequest: BundleOptions }> {\n  const exp = getConfig(projectRoot, { skipSDKVersionRequirement: true }).exp;\n\n  // TODO: This is slow ~40ms\n  const { config } = await loadMetroConfigAsync(\n    projectRoot,\n    {\n      maxWorkers: options.maxWorkers,\n      resetCache: false, //options.resetCache,\n      config: options.config,\n    },\n    {\n      exp,\n      isExporting: true,\n    }\n  );\n\n  const isHermes = isEnableHermesManaged(exp, options.platform);\n\n  let sourceMapUrl = options.sourcemapOutput;\n  if (sourceMapUrl && !options.sourcemapUseAbsolutePath) {\n    sourceMapUrl = path.basename(sourceMapUrl);\n  }\n\n  const bundleRequest = {\n    ...Server.DEFAULT_BUNDLE_OPTIONS,\n    ...getMetroDirectBundleOptionsForExpoConfig(projectRoot, exp, {\n      mainModuleName: options.entryFile,\n      platform: options.platform,\n      minify: options.minify,\n      mode: options.dev ? 'development' : 'production',\n      engine: isHermes ? 'hermes' : undefined,\n      bytecode: isHermes,\n      isExporting: true,\n    }),\n    sourceMapUrl,\n    unstable_transformProfile: (options.unstableTransformProfile ||\n      (isHermes ? 'hermes-stable' : 'default')) as BundleOptions['unstable_transformProfile'],\n  };\n\n  const server = new Server(config, {\n    watch: false,\n  });\n\n  return { server, bundleRequest };\n}\n\nexport async function exportEmbedBundleAndAssetsAsync(\n  projectRoot: string,\n  options: Options\n): Promise<{\n  bundle: Awaited<ReturnType<Server['build']>>;\n  assets: Awaited<ReturnType<typeof getAssets>>;\n}> {\n  const { server, bundleRequest } = await createMetroServerAndBundleRequestAsync(\n    projectRoot,\n    options\n  );\n\n  try {\n    const bundle = await exportEmbedBundleAsync(server, bundleRequest, projectRoot, options);\n    const assets = await exportEmbedAssetsAsync(server, bundleRequest, projectRoot, options);\n    return { bundle, assets };\n  } finally {\n    server.end();\n  }\n}\n\nexport async function exportEmbedBundleAsync(\n  server: Server,\n  bundleRequest: BundleOptions,\n  projectRoot: string,\n  options: Pick<Options, 'platform'>\n) {\n  try {\n    return await profile(\n      server.build.bind(server),\n      'metro-bundle'\n    )({\n      ...bundleRequest,\n      bundleType: 'bundle',\n    });\n  } catch (error: any) {\n    if (isError(error)) {\n      // Log using Xcode error format so the errors are picked up by xcodebuild.\n      // https://developer.apple.com/documentation/xcode/running-custom-scripts-during-a-build#Log-errors-and-warnings-from-your-script\n      if (options.platform === 'ios') {\n        // If the error is about to be presented in Xcode, strip the ansi characters from the message.\n        if ('message' in error && isExecutingFromXcodebuild()) {\n          error.message = stripAnsi(error.message) as string;\n        }\n        logMetroErrorInXcode(projectRoot, error);\n      }\n    }\n    throw error;\n  }\n}\n\nexport async function exportEmbedAssetsAsync(\n  server: Server,\n  bundleRequest: BundleOptions,\n  projectRoot: string,\n  options: Pick<Options, 'platform'>\n) {\n  try {\n    return await getAssets(server, {\n      ...bundleRequest,\n      bundleType: 'todo',\n    });\n  } catch (error: any) {\n    if (isError(error)) {\n      // Log using Xcode error format so the errors are picked up by xcodebuild.\n      // https://developer.apple.com/documentation/xcode/running-custom-scripts-during-a-build#Log-errors-and-warnings-from-your-script\n      if (options.platform === 'ios') {\n        // If the error is about to be presented in Xcode, strip the ansi characters from the message.\n        if ('message' in error && isExecutingFromXcodebuild()) {\n          error.message = stripAnsi(error.message) as string;\n        }\n        logMetroErrorInXcode(projectRoot, error);\n      }\n    }\n    throw error;\n  }\n}\n\nfunction isError(error: any): error is Error {\n  return error instanceof Error;\n}\n"],"names":["exportEmbedAsync","createMetroServerAndBundleRequestAsync","exportEmbedBundleAndAssetsAsync","exportEmbedBundleAsync","exportEmbedAssetsAsync","debug","require","guessCopiedAppleBundlePath","bundleOutput","match","bundleName","path","basename","bundleParent","dirname","possiblePath","globSync","join","dot","projectRoot","options","setNodeEnv","dev","load","removeAsync","platform","previousPath","fs","existsSync","bundle","assets","mkdirSync","recursive","mode","Promise","all","output","save","Log","log","assetsDest","persistMetroAssetsAsync","outputDirectory","iosAssetCatalogDirectory","assetCatalogDest","exp","getConfig","skipSDKVersionRequirement","config","loadMetroConfigAsync","maxWorkers","resetCache","isExporting","isHermes","isEnableHermesManaged","sourceMapUrl","sourcemapOutput","sourcemapUseAbsolutePath","bundleRequest","Server","DEFAULT_BUNDLE_OPTIONS","getMetroDirectBundleOptionsForExpoConfig","mainModuleName","entryFile","minify","engine","undefined","bytecode","unstable_transformProfile","unstableTransformProfile","server","watch","end","profile","build","bind","bundleType","error","isError","isExecutingFromXcodebuild","message","stripAnsi","logMetroErrorInXcode","getAssets","Error"],"mappings":"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"}