{"version":3,"sources":["../../../src/export/exportApp.ts"],"sourcesContent":["import { getConfig } from '@expo/config';\nimport chalk from 'chalk';\nimport path from 'path';\n\nimport { createMetadataJson } from './createMetadataJson';\nimport { exportAssetsAsync } from './exportAssets';\nimport { unstable_exportStaticAsync } from './exportStaticAsync';\nimport { getVirtualFaviconAssetsAsync } from './favicon';\nimport { createBundlesAsync } from './fork-bundleAsync';\nimport { getPublicExpoManifestAsync } from './getPublicExpoManifest';\nimport { copyPublicFolderAsync } from './publicFolder';\nimport { Options } from './resolveOptions';\nimport { ExportAssetMap, getFilesFromSerialAssets, persistMetroFilesAsync } from './saveAssets';\nimport { createAssetMap, createSourceMapDebugHtml } from './writeContents';\nimport * as Log from '../log';\nimport { WebSupportProjectPrerequisite } from '../start/doctor/web/WebSupportProjectPrerequisite';\nimport { getRouterDirectoryModuleIdWithManifest } from '../start/server/metro/router';\nimport { serializeHtmlWithAssets } from '../start/server/metro/serializeHtml';\nimport {\n  getAsyncRoutesFromExpoConfig,\n  getBaseUrlFromExpoConfig,\n} from '../start/server/middleware/metroOptions';\nimport { createTemplateHtmlFromExpoConfigAsync } from '../start/server/webTemplate';\nimport { env } from '../utils/env';\nimport { setNodeEnv } from '../utils/nodeEnv';\n\nexport async function exportAppAsync(\n  projectRoot: string,\n  {\n    platforms,\n    outputDir,\n    clear,\n    dev,\n    dumpAssetmap,\n    sourceMaps,\n    minify,\n    bytecode,\n    maxWorkers,\n  }: Pick<\n    Options,\n    | 'dumpAssetmap'\n    | 'sourceMaps'\n    | 'dev'\n    | 'clear'\n    | 'outputDir'\n    | 'platforms'\n    | 'minify'\n    | 'bytecode'\n    | 'maxWorkers'\n  >\n): Promise<void> {\n  setNodeEnv(dev ? 'development' : 'production');\n  require('@expo/env').load(projectRoot);\n\n  const projectConfig = getConfig(projectRoot);\n  const exp = await getPublicExpoManifestAsync(projectRoot, {\n    // Web doesn't require validation.\n    skipValidation: platforms.length === 1 && platforms[0] === 'web',\n  });\n\n  if (platforms.includes('web')) {\n    await new WebSupportProjectPrerequisite(projectRoot).assertAsync();\n  }\n\n  const useServerRendering = ['static', 'server'].includes(exp.web?.output ?? '');\n  const baseUrl = getBaseUrlFromExpoConfig(exp);\n\n  if (!bytecode && (platforms.includes('ios') || platforms.includes('android'))) {\n    Log.warn(\n      `Bytecode makes the app startup faster, disabling bytecode is highly discouraged and should only be used for debugging purposes.`\n    );\n  }\n\n  // Print out logs\n  if (baseUrl) {\n    Log.log();\n    Log.log(chalk.gray`Using (experimental) base path: ${baseUrl}`);\n    // Warn if not using an absolute path.\n    if (!baseUrl.startsWith('/')) {\n      Log.log(\n        chalk.yellow`  Base path does not start with a slash. Requests will not be absolute.`\n      );\n    }\n  }\n\n  const publicPath = path.resolve(projectRoot, env.EXPO_PUBLIC_FOLDER);\n  const outputPath = path.resolve(projectRoot, outputDir);\n\n  // NOTE(kitten): The public folder is currently always copied, regardless of targetDomain\n  // split. Hence, there's another separate `copyPublicFolderAsync` call below for `web`\n  await copyPublicFolderAsync(publicPath, outputPath);\n\n  // Run metro bundler and create the JS bundles/source maps.\n  const bundles = await createBundlesAsync(projectRoot, projectConfig, {\n    clear: !!clear,\n    minify,\n    bytecode,\n    sourcemaps: sourceMaps,\n    platforms: useServerRendering ? platforms.filter((platform) => platform !== 'web') : platforms,\n    dev,\n    maxWorkers,\n  });\n\n  // Write the JS bundles to disk, and get the bundle file names (this could change with async chunk loading support).\n\n  const files: ExportAssetMap = new Map();\n\n  Object.values(bundles).forEach((bundle) => {\n    getFilesFromSerialAssets(bundle.artifacts, {\n      includeSourceMaps: sourceMaps,\n      files,\n    });\n  });\n\n  const bundleEntries = Object.entries(bundles);\n  // Can be empty during web-only SSG.\n  if (bundleEntries.length) {\n    // TODO: Use same asset system across platforms again.\n    const { assets, embeddedHashSet } = await exportAssetsAsync(projectRoot, {\n      files,\n      exp,\n      outputDir: outputPath,\n      bundles,\n      baseUrl,\n    });\n\n    if (dumpAssetmap) {\n      Log.log('Creating asset map');\n      files.set('assetmap.json', { contents: JSON.stringify(createAssetMap({ assets })) });\n    }\n\n    const fileNames = Object.fromEntries(\n      Object.entries(bundles).map(([platform, bundle]) => [\n        platform,\n        bundle.artifacts.filter((asset) => asset.type === 'js').map((asset) => asset.filename),\n      ])\n    );\n\n    // build source maps\n    if (sourceMaps) {\n      Log.log('Preparing additional debugging files');\n      // If we output source maps, then add a debug HTML file which the user can open in\n      // the web browser to inspect the output like web.\n      files.set('debug.html', {\n        contents: createSourceMapDebugHtml({\n          fileNames: Object.values(fileNames).flat(),\n        }),\n      });\n    }\n\n    // Generate a `metadata.json` for EAS Update.\n    const contents = createMetadataJson({\n      bundles,\n      fileNames,\n      embeddedHashSet,\n    });\n    files.set('metadata.json', { contents: JSON.stringify(contents) });\n  }\n\n  // Additional web-only steps...\n\n  if (platforms.includes('web')) {\n    if (useServerRendering) {\n      const exportServer = exp.web?.output === 'server';\n\n      if (exportServer) {\n        // TODO: Remove when this is abstracted into the files map\n        await copyPublicFolderAsync(publicPath, path.resolve(outputPath, 'client'));\n      }\n\n      await unstable_exportStaticAsync(projectRoot, {\n        files,\n        clear: !!clear,\n        outputDir: outputPath,\n        minify,\n        baseUrl,\n        includeSourceMaps: sourceMaps,\n        asyncRoutes: getAsyncRoutesFromExpoConfig(exp, dev ? 'development' : 'production', 'web'),\n        routerRoot: getRouterDirectoryModuleIdWithManifest(projectRoot, exp),\n        exportServer,\n        maxWorkers,\n      });\n    } else {\n      // TODO: Unify with exportStaticAsync\n      // TODO: Maybe move to the serializer.\n      let html = await serializeHtmlWithAssets({\n        mode: 'production',\n        resources: bundles.web!.artifacts,\n        template: await createTemplateHtmlFromExpoConfigAsync(projectRoot, {\n          scripts: [],\n          cssLinks: [],\n        }),\n        baseUrl,\n      });\n\n      // Add the favicon assets to the HTML.\n      const modifyHtml = await getVirtualFaviconAssetsAsync(projectRoot, {\n        outputDir,\n        baseUrl,\n        files,\n      });\n      if (modifyHtml) {\n        html = modifyHtml(html);\n      }\n\n      // Generate SPA-styled HTML file.\n      // If web exists, then write the template HTML file.\n      files.set('index.html', {\n        contents: html,\n        targetDomain: 'client',\n      });\n    }\n  }\n\n  // Write all files at the end for unified logging.\n  await persistMetroFilesAsync(files, outputPath);\n}\n"],"names":["exportAppAsync","Log","projectRoot","platforms","outputDir","clear","dev","dumpAssetmap","sourceMaps","minify","bytecode","maxWorkers","exp","setNodeEnv","require","load","projectConfig","getConfig","getPublicExpoManifestAsync","skipValidation","length","includes","WebSupportProjectPrerequisite","assertAsync","useServerRendering","web","output","baseUrl","getBaseUrlFromExpoConfig","warn","log","chalk","gray","startsWith","yellow","publicPath","path","resolve","env","EXPO_PUBLIC_FOLDER","outputPath","copyPublicFolderAsync","bundles","createBundlesAsync","sourcemaps","filter","platform","files","Map","Object","values","forEach","bundle","getFilesFromSerialAssets","artifacts","includeSourceMaps","bundleEntries","entries","assets","embeddedHashSet","exportAssetsAsync","set","contents","JSON","stringify","createAssetMap","fileNames","fromEntries","map","asset","type","filename","createSourceMapDebugHtml","flat","createMetadataJson","exportServer","unstable_exportStaticAsync","asyncRoutes","getAsyncRoutesFromExpoConfig","routerRoot","getRouterDirectoryModuleIdWithManifest","html","serializeHtmlWithAssets","mode","resources","template","createTemplateHtmlFromExpoConfigAsync","scripts","cssLinks","modifyHtml","getVirtualFaviconAssetsAsync","targetDomain","persistMetroFilesAsync"],"mappings":"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"}