{"version":3,"sources":["../../../../../../../src/start/server/metro/debugging/inspectorHandlers/VscodeDebuggerScriptParsed.ts"],"sourcesContent":["import { unstable_Device as MetroDevice } from '@react-native/dev-middleware';\nimport Protocol from 'devtools-protocol';\n\nimport { CdpMessage, DebuggerMetadata, DeviceRequest, InspectorHandler } from './types';\nimport { getDebuggerType } from './utils';\n\n/** Android's stock emulator and other emulators such as genymotion use a standard localhost alias. */\nconst EMULATOR_LOCALHOST_ADDRESSES: Readonly<string[]> = ['10.0.2.2', '10.0.3.2'];\n/** Prefix for script URLs that are alphanumeric IDs. */\nconst FILE_PREFIX = 'file://';\n\n/**\n * Some debug clients does not support fetching source maps by URL.\n * By default, the `@react-native/dev-middleware` inlines the source map as base64 string.\n * Unfortunately, that causes a multi-second delay in VS Code (Â±5s).\n * This handler disables inlining the source maps for VS Code only.\n */\nexport class VscodeDebuggerScriptParsedHandler implements InspectorHandler {\n  constructor(private readonly device: MetroDevice) {}\n\n  onDeviceMessage(message: DeviceRequest<DebuggerScriptParsed>, debuggerInfo: DebuggerMetadata) {\n    if (\n      getDebuggerType(debuggerInfo.userAgent) !== 'vscode' ||\n      message.method !== 'Debugger.scriptParsed'\n    ) {\n      return false;\n    }\n\n    // See: https://github.com/facebook/metro/blob/f43caa371a813b257cb0b42028079645a1e85e0e/packages/metro-inspector-proxy/src/Device.js#L401-L410\n    if (message.params.sourceMapURL) {\n      for (let i = 0; i < EMULATOR_LOCALHOST_ADDRESSES.length; ++i) {\n        const address = EMULATOR_LOCALHOST_ADDRESSES[i];\n        if (message.params.sourceMapURL.indexOf(address) >= 0) {\n          message.params.sourceMapURL = message.params.sourceMapURL.replace(address, 'localhost');\n          debuggerInfo.originalSourceURLAddress = address;\n        }\n      }\n    }\n\n    // See: https://github.com/facebook/metro/blob/f43caa371a813b257cb0b42028079645a1e85e0e/packages/metro-inspector-proxy/src/Device.js#L431-L453\n    if (message.params.url) {\n      for (let i = 0; i < EMULATOR_LOCALHOST_ADDRESSES.length; ++i) {\n        const address = EMULATOR_LOCALHOST_ADDRESSES[i];\n        if (message.params.url.indexOf(address) >= 0) {\n          message.params.url = message.params.url.replace(address, 'localhost');\n          debuggerInfo.originalSourceURLAddress = address;\n        }\n      }\n\n      // Chrome doesn't download source maps if URL param is not a valid\n      // URL. Some frameworks pass alphanumeric script ID instead of URL which causes\n      // Chrome to not download source maps. In this case we want to prepend script ID\n      // with 'file://' prefix.\n      if (message.params.url.match(/^[0-9a-z]+$/)) {\n        message.params.url = FILE_PREFIX + message.params.url;\n        debuggerInfo.prependedFilePrefix = true;\n      }\n\n      if (message.params.scriptId != null) {\n        this.device._scriptIdToSourcePathMapping.set(message.params.scriptId, message.params.url);\n      }\n    }\n\n    // Block `@react-native/dev-middleware`'s default source map inlining\n    return true;\n  }\n}\n\n/** @see https://chromedevtools.github.io/devtools-protocol/v8/Debugger/#event-scriptParsed */\nexport type DebuggerScriptParsed = CdpMessage<\n  'Debugger.scriptParsed',\n  Protocol.Debugger.ScriptParsedEvent,\n  never\n>;\n"],"names":["EMULATOR_LOCALHOST_ADDRESSES","FILE_PREFIX","VscodeDebuggerScriptParsedHandler","constructor","device","onDeviceMessage","message","debuggerInfo","getDebuggerType","userAgent","method","params","sourceMapURL","i","length","address","indexOf","replace","originalSourceURLAddress","url","match","prependedFilePrefix","scriptId","_scriptIdToSourcePathMapping","set"],"mappings":"AAAA;;;;AAIgC,IAAA,MAAS,WAAT,SAAS,CAAA;AAEzC,sGAAsG,CACtG,MAAMA,4BAA4B,GAAuB;IAAC,UAAU;IAAE,UAAU;CAAC,AAAC;AAClF,wDAAwD,CACxD,MAAMC,WAAW,GAAG,SAAS,AAAC;AAQvB,MAAMC,iCAAiC;IAC5CC,YAA6BC,MAAmB,CAAE;aAArBA,MAAmB,GAAnBA,MAAmB;KAAI;IAEpDC,eAAe,CAACC,OAA4C,EAAEC,YAA8B,EAAE;QAC5F,IACEC,CAAAA,GAAAA,MAAe,AAAwB,CAAA,gBAAxB,CAACD,YAAY,CAACE,SAAS,CAAC,KAAK,QAAQ,IACpDH,OAAO,CAACI,MAAM,KAAK,uBAAuB,EAC1C;YACA,OAAO,KAAK,CAAC;SACd;QAED,8IAA8I;QAC9I,IAAIJ,OAAO,CAACK,MAAM,CAACC,YAAY,EAAE;YAC/B,IAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGb,4BAA4B,CAACc,MAAM,EAAE,EAAED,CAAC,CAAE;gBAC5D,MAAME,OAAO,GAAGf,4BAA4B,CAACa,CAAC,CAAC,AAAC;gBAChD,IAAIP,OAAO,CAACK,MAAM,CAACC,YAAY,CAACI,OAAO,CAACD,OAAO,CAAC,IAAI,CAAC,EAAE;oBACrDT,OAAO,CAACK,MAAM,CAACC,YAAY,GAAGN,OAAO,CAACK,MAAM,CAACC,YAAY,CAACK,OAAO,CAACF,OAAO,EAAE,WAAW,CAAC,CAAC;oBACxFR,YAAY,CAACW,wBAAwB,GAAGH,OAAO,CAAC;iBACjD;aACF;SACF;QAED,8IAA8I;QAC9I,IAAIT,OAAO,CAACK,MAAM,CAACQ,GAAG,EAAE;YACtB,IAAK,IAAIN,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGb,4BAA4B,CAACc,MAAM,EAAE,EAAED,CAAC,CAAE;gBAC5D,MAAME,OAAO,GAAGf,4BAA4B,CAACa,CAAC,CAAC,AAAC;gBAChD,IAAIP,OAAO,CAACK,MAAM,CAACQ,GAAG,CAACH,OAAO,CAACD,OAAO,CAAC,IAAI,CAAC,EAAE;oBAC5CT,OAAO,CAACK,MAAM,CAACQ,GAAG,GAAGb,OAAO,CAACK,MAAM,CAACQ,GAAG,CAACF,OAAO,CAACF,OAAO,EAAE,WAAW,CAAC,CAAC;oBACtER,YAAY,CAACW,wBAAwB,GAAGH,OAAO,CAAC;iBACjD;aACF;YAED,kEAAkE;YAClE,+EAA+E;YAC/E,gFAAgF;YAChF,yBAAyB;YACzB,IAAIT,OAAO,CAACK,MAAM,CAACQ,GAAG,CAACC,KAAK,eAAe,EAAE;gBAC3Cd,OAAO,CAACK,MAAM,CAACQ,GAAG,GAAGlB,WAAW,GAAGK,OAAO,CAACK,MAAM,CAACQ,GAAG,CAAC;gBACtDZ,YAAY,CAACc,mBAAmB,GAAG,IAAI,CAAC;aACzC;YAED,IAAIf,OAAO,CAACK,MAAM,CAACW,QAAQ,IAAI,IAAI,EAAE;gBACnC,IAAI,CAAClB,MAAM,CAACmB,4BAA4B,CAACC,GAAG,CAAClB,OAAO,CAACK,MAAM,CAACW,QAAQ,EAAEhB,OAAO,CAACK,MAAM,CAACQ,GAAG,CAAC,CAAC;aAC3F;SACF;QAED,qEAAqE;QACrE,OAAO,IAAI,CAAC;KACb;CACF;QAjDYjB,iCAAiC,GAAjCA,iCAAiC"}