{"version":3,"sources":["../../../src/export/fork-bundleAsync.ts"],"sourcesContent":["import { ExpoConfig, getConfigFilePaths, Platform, ProjectConfig } from '@expo/config';\nimport { LoadOptions } from '@expo/metro-config';\nimport { SerialAsset } from '@expo/metro-config/build/serializer/serializerAssets';\nimport getMetroAssets from '@expo/metro-config/build/transform-worker/getAssets';\nimport assert from 'assert';\nimport Metro, { MixedOutput, Module, ReadOnlyGraph } from 'metro';\nimport type { TransformInputOptions } from 'metro/src/DeltaBundler/types';\nimport IncrementalBundler from 'metro/src/IncrementalBundler';\nimport Server from 'metro/src/Server';\nimport splitBundleOptions from 'metro/src/lib/splitBundleOptions';\nimport type {\n  ResolverInputOptions,\n  BundleOptions as MetroBundleOptions,\n} from 'metro/src/shared/types';\nimport { ConfigT } from 'metro-config';\nimport path from 'path';\n\nimport { isEnableHermesManaged, maybeThrowFromInconsistentEngineAsync } from './exportHermes';\nimport { loadMetroConfigAsync } from '../start/server/metro/instantiateMetro';\nimport { getEntryWithServerRoot } from '../start/server/middleware/ManifestMiddleware';\nimport {\n  ExpoMetroBundleOptions,\n  getMetroDirectBundleOptionsForExpoConfig,\n} from '../start/server/middleware/metroOptions';\nimport { CommandError } from '../utils/errors';\n\nexport type MetroDevServerOptions = LoadOptions;\n\nexport type BundleOptions = {\n  entryPoint: string;\n  platform: 'android' | 'ios' | 'web';\n  dev?: boolean;\n  minify?: boolean;\n  bytecode: boolean;\n  sourceMapUrl?: string;\n  sourcemaps?: boolean;\n};\nexport type BundleAssetWithFileHashes = Metro.AssetData & {\n  fileHashes: string[]; // added by the hashAssets asset plugin\n};\nexport type BundleOutput = {\n  artifacts: SerialAsset[];\n  assets: readonly BundleAssetWithFileHashes[];\n};\n\nlet nextBuildID = 0;\n\nasync function assertEngineMismatchAsync(\n  projectRoot: string,\n  exp: Pick<ExpoConfig, 'ios' | 'android' | 'jsEngine'>,\n  platform: Platform\n) {\n  const isHermesManaged = isEnableHermesManaged(exp, platform);\n\n  const paths = getConfigFilePaths(projectRoot);\n  const configFilePath = paths.dynamicConfigPath ?? paths.staticConfigPath ?? 'app.json';\n  await maybeThrowFromInconsistentEngineAsync(\n    projectRoot,\n    configFilePath,\n    platform,\n    isHermesManaged\n  );\n}\n\nexport async function createBundlesAsync(\n  projectRoot: string,\n  projectConfig: ProjectConfig,\n  bundleOptions: {\n    clear?: boolean;\n    maxWorkers?: number;\n    platforms: Platform[];\n    dev?: boolean;\n    minify?: boolean;\n    bytecode: boolean;\n    sourcemaps?: boolean;\n    entryPoint?: string;\n  }\n): Promise<Partial<Record<Platform, BundleOutput>>> {\n  if (!bundleOptions.platforms.length) {\n    return {};\n  }\n  const { exp, pkg } = projectConfig;\n\n  const bundles = await bundleProductionMetroClientAsync(\n    projectRoot,\n    exp,\n    {\n      // If not legacy, ignore the target option to prevent warnings from being thrown.\n      resetCache: bundleOptions.clear,\n      maxWorkers: bundleOptions.maxWorkers,\n    },\n    bundleOptions.platforms.map((platform: Platform) => ({\n      platform,\n      entryPoint:\n        bundleOptions.entryPoint ?? getEntryWithServerRoot(projectRoot, { platform, pkg }),\n      sourcemaps: bundleOptions.sourcemaps,\n      minify: bundleOptions.minify,\n      bytecode: bundleOptions.bytecode,\n      dev: bundleOptions.dev,\n    }))\n  );\n\n  // { ios: bundle, android: bundle }\n  return bundleOptions.platforms.reduce<Partial<Record<Platform, BundleOutput>>>(\n    (prev, platform, index) => ({\n      ...prev,\n      [platform]: bundles[index],\n    }),\n    {}\n  );\n}\n\nfunction assertMetroConfig(\n  config: ConfigT\n): asserts config is ConfigT & { serializer: NonNullable<ConfigT['serializer']> } {\n  if (!config.serializer?.customSerializer) {\n    throw new CommandError(\n      'METRO_CONFIG_MALFORMED',\n      `The Metro bundler configuration is missing required features from 'expo/metro-config' and cannot be used with Expo CLI. Ensure the metro.config.js file is extending 'expo/metro-config'. Learn more: https://docs.expo.dev/guides/customizing-metro`\n    );\n  }\n}\n\nasync function bundleProductionMetroClientAsync(\n  projectRoot: string,\n  expoConfig: ExpoConfig,\n  metroOptions: MetroDevServerOptions,\n  bundles: BundleOptions[]\n): Promise<BundleOutput[]> {\n  // Assert early so the user doesn't have to wait until bundling is complete to find out that\n  // Hermes won't be available.\n  await Promise.all(\n    bundles.map(({ platform }) => assertEngineMismatchAsync(projectRoot, expoConfig, platform))\n  );\n\n  const { config, reporter } = await loadMetroConfigAsync(projectRoot, metroOptions, {\n    exp: expoConfig,\n    isExporting: true,\n  });\n\n  assertMetroConfig(config);\n\n  const metroServer = await Metro.runMetro(config, {\n    watch: false,\n  });\n\n  const buildAsync = async (bundle: BundleOptions): Promise<BundleOutput> => {\n    const buildID = `bundle_${nextBuildID++}_${bundle.platform}`;\n    const isHermes = isEnableHermesManaged(expoConfig, bundle.platform);\n    if (isHermes) {\n      await assertEngineMismatchAsync(projectRoot, expoConfig, bundle.platform);\n    }\n    const bundleOptions: MetroBundleOptions = {\n      ...Server.DEFAULT_BUNDLE_OPTIONS,\n      sourceMapUrl: bundle.sourceMapUrl,\n      ...getMetroDirectBundleOptionsForExpoConfig(projectRoot, expoConfig, {\n        minify: bundle.minify,\n        mainModuleName: bundle.entryPoint,\n        platform: bundle.platform,\n        mode: bundle.dev ? 'development' : 'production',\n        engine: isHermes ? 'hermes' : undefined,\n        serializerIncludeMaps: bundle.sourcemaps,\n        bytecode: bundle.bytecode && isHermes,\n        // Bundle splitting on web-only for now.\n        // serializerOutput: bundle.platform === 'web' ? 'static' : undefined,\n        serializerOutput: 'static',\n        isExporting: true,\n      }),\n      bundleType: 'bundle',\n      inlineSourceMap: false,\n      createModuleIdFactory: config.serializer.createModuleIdFactory,\n      onProgress: (transformedFileCount: number, totalFileCount: number) => {\n        reporter.update({\n          buildID,\n          type: 'bundle_transform_progressed',\n          transformedFileCount,\n          totalFileCount,\n        });\n      },\n    };\n\n    const bundleDetails = {\n      ...bundleOptions,\n      buildID,\n    };\n    reporter.update({\n      buildID,\n      type: 'bundle_build_started',\n      bundleDetails,\n    });\n    try {\n      const artifacts = await forkMetroBuildAsync(metroServer, bundleOptions);\n      reporter.update({\n        buildID,\n        type: 'bundle_build_done',\n      });\n      return artifacts;\n    } catch (error) {\n      reporter.update({\n        buildID,\n        type: 'bundle_build_failed',\n      });\n\n      throw error;\n    }\n  };\n\n  try {\n    return await Promise.all(bundles.map((bundle) => buildAsync(bundle)));\n  } catch (error) {\n    // New line so errors don't show up inline with the progress bar\n    console.log('');\n    throw error;\n  } finally {\n    metroServer.end();\n  }\n}\n\n// Forked out of Metro because the `this._getServerRootDir()` doesn't match the development\n// behavior.\nexport async function getAssets(metro: Metro.Server, options: MetroBundleOptions) {\n  const { entryFile, onProgress, resolverOptions, transformOptions } = splitBundleOptions(options);\n\n  // @ts-expect-error: _bundler isn't exposed on the type.\n  const dependencies = await metro._bundler.getDependencies(\n    [entryFile],\n    transformOptions,\n    resolverOptions,\n    { onProgress, shallow: false, lazy: false }\n  );\n\n  // @ts-expect-error\n  const _config = metro._config as ConfigT;\n\n  return getMetroAssets(dependencies, {\n    processModuleFilter: _config.serializer.processModuleFilter,\n    assetPlugins: _config.transformer.assetPlugins,\n    platform: transformOptions.platform!,\n    projectRoot: _config.projectRoot, // this._getServerRootDir(),\n    publicPath: _config.transformer.publicPath,\n  });\n}\n\nfunction isMetroServerInstance(metro: Metro.Server): metro is Metro.Server & {\n  _shouldAddModuleToIgnoreList: (module: Module<MixedOutput>) => boolean;\n  _bundler: IncrementalBundler;\n  _config: ConfigT;\n  _createModuleId: (path: string) => number;\n  _resolveRelativePath(\n    filePath: string,\n    {\n      relativeTo,\n      resolverOptions,\n      transformOptions,\n    }: {\n      relativeTo: 'project' | 'server';\n      resolverOptions: ResolverInputOptions;\n      transformOptions: TransformInputOptions;\n    }\n  ): Promise<string>;\n  _getEntryPointAbsolutePath(entryFile: string): string;\n  _getSortedModules(graph: ReadOnlyGraph): Module<MixedOutput>[];\n} {\n  return '_shouldAddModuleToIgnoreList' in metro;\n}\n\nasync function forkMetroBuildAsync(\n  metro: Metro.Server,\n  options: ExpoMetroBundleOptions\n): Promise<{ artifacts: SerialAsset[]; assets: readonly BundleAssetWithFileHashes[] }> {\n  if (!isMetroServerInstance(metro)) {\n    throw new Error('Expected Metro server instance to have private functions exposed.');\n  }\n\n  if (options.serializerOptions?.output !== 'static') {\n    throw new Error('Only multi-serializer output is supported.');\n  }\n\n  const {\n    entryFile,\n    graphOptions,\n    onProgress,\n    resolverOptions,\n    serializerOptions,\n    transformOptions,\n  } = splitBundleOptions(options);\n\n  const { prepend, graph } = await metro._bundler.buildGraph(\n    entryFile,\n    transformOptions,\n    resolverOptions,\n    {\n      onProgress,\n      shallow: graphOptions.shallow,\n      // @ts-expect-error\n      lazy: graphOptions.lazy,\n    }\n  );\n\n  const entryPoint = metro._getEntryPointAbsolutePath(entryFile);\n\n  const bundleOptions = {\n    asyncRequireModulePath: await metro._resolveRelativePath(\n      metro._config.transformer.asyncRequireModulePath,\n      {\n        relativeTo: 'project',\n        resolverOptions,\n        transformOptions,\n      }\n    ),\n    processModuleFilter: metro._config.serializer.processModuleFilter,\n    createModuleId: metro._createModuleId,\n    getRunModuleStatement: metro._config.serializer.getRunModuleStatement,\n    dev: transformOptions.dev,\n    includeAsyncPaths: graphOptions.lazy,\n    projectRoot: metro._config.projectRoot,\n    modulesOnly: serializerOptions.modulesOnly,\n    runBeforeMainModule: metro._config.serializer.getModulesRunBeforeMainModule(\n      path.relative(metro._config.projectRoot, entryPoint)\n    ),\n    runModule: serializerOptions.runModule,\n    sourceMapUrl: serializerOptions.sourceMapUrl,\n    sourceUrl: serializerOptions.sourceUrl,\n    inlineSourceMap: serializerOptions.inlineSourceMap,\n    serverRoot: metro._config.server.unstable_serverRoot ?? metro._config.projectRoot,\n    shouldAddToIgnoreList: (module: Module<MixedOutput>) =>\n      metro._shouldAddModuleToIgnoreList(module),\n    // Custom options we pass to the serializer to emulate the URL query parameters.\n    serializerOptions: options.serializerOptions,\n  };\n\n  assertMetroConfig(metro._config);\n\n  const bundle = await metro._config.serializer.customSerializer!(\n    entryPoint,\n    // @ts-expect-error: Metro is typed incorrectly\n    prepend,\n    graph,\n    bundleOptions\n  );\n\n  try {\n    const parsed = typeof bundle === 'string' ? JSON.parse(bundle) : bundle;\n\n    assert(\n      'artifacts' in parsed && Array.isArray(parsed.artifacts),\n      'Expected serializer to return an object with key artifacts to contain an array of serial assets.'\n    );\n    return parsed;\n  } catch (error: any) {\n    throw new Error(\n      'Serializer did not return expected format. The project copy of `expo/metro-config` may be out of date. Error: ' +\n        error.message\n    );\n  }\n}\n"],"names":["createBundlesAsync","getAssets","nextBuildID","assertEngineMismatchAsync","projectRoot","exp","platform","isHermesManaged","isEnableHermesManaged","paths","getConfigFilePaths","configFilePath","dynamicConfigPath","staticConfigPath","maybeThrowFromInconsistentEngineAsync","projectConfig","bundleOptions","platforms","length","pkg","bundles","bundleProductionMetroClientAsync","resetCache","clear","maxWorkers","map","entryPoint","getEntryWithServerRoot","sourcemaps","minify","bytecode","dev","reduce","prev","index","assertMetroConfig","config","serializer","customSerializer","CommandError","expoConfig","metroOptions","Promise","all","reporter","loadMetroConfigAsync","isExporting","metroServer","Metro","runMetro","watch","buildAsync","bundle","buildID","isHermes","Server","DEFAULT_BUNDLE_OPTIONS","sourceMapUrl","getMetroDirectBundleOptionsForExpoConfig","mainModuleName","mode","engine","undefined","serializerIncludeMaps","serializerOutput","bundleType","inlineSourceMap","createModuleIdFactory","onProgress","transformedFileCount","totalFileCount","update","type","bundleDetails","artifacts","forkMetroBuildAsync","error","console","log","end","metro","options","entryFile","resolverOptions","transformOptions","splitBundleOptions","dependencies","_bundler","getDependencies","shallow","lazy","_config","getMetroAssets","processModuleFilter","assetPlugins","transformer","publicPath","isMetroServerInstance","Error","serializerOptions","output","graphOptions","prepend","graph","buildGraph","_getEntryPointAbsolutePath","asyncRequireModulePath","_resolveRelativePath","relativeTo","createModuleId","_createModuleId","getRunModuleStatement","includeAsyncPaths","modulesOnly","runBeforeMainModule","getModulesRunBeforeMainModule","path","relative","runModule","sourceUrl","serverRoot","server","unstable_serverRoot","shouldAddToIgnoreList","module","_shouldAddModuleToIgnoreList","parsed","JSON","parse","assert","Array","isArray","message"],"mappings":"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"}