{"version":3,"sources":["../../../../../../../src/start/server/metro/debugging/inspectorHandlers/VscodeRuntimeGetProperties.ts"],"sourcesContent":["import Protocol from 'devtools-protocol';\n\nimport {\n  CdpMessage,\n  DebuggerMetadata,\n  DebuggerRequest,\n  DeviceResponse,\n  InspectorHandler,\n} from './types';\nimport { getDebuggerType } from './utils';\n\n/**\n * Vscode doesn't seem to work nicely with missing `description` fields on `RemoteObject` instances.\n * It also tries to invoke `Runtime.callFunctionOn` on `Symbol` types, which crashes Hermes.\n * This handler tries to compensate for these two separate issues.\n *\n * @see https://github.com/facebook/hermes/issues/114\n * @see https://github.com/microsoft/vscode-js-debug/issues/1583\n */\nexport class VscodeRuntimeGetPropertiesHandler implements InspectorHandler {\n  /** Keep track of `Runtime.getProperties` responses to intercept, by request id */\n  interceptGetProperties = new Set<number>();\n\n  onDebuggerMessage(\n    message: DebuggerRequest<RuntimeGetProperties>,\n    { userAgent }: DebuggerMetadata\n  ): boolean {\n    if (getDebuggerType(userAgent) === 'vscode' && message.method === 'Runtime.getProperties') {\n      this.interceptGetProperties.add(message.id);\n    }\n\n    // Do not block propagation of this message\n    return false;\n  }\n\n  onDeviceMessage(message: DeviceResponse<RuntimeGetProperties>, { userAgent }: DebuggerMetadata) {\n    if (\n      getDebuggerType(userAgent) === 'vscode' &&\n      'id' in message &&\n      this.interceptGetProperties.has(message.id)\n    ) {\n      this.interceptGetProperties.delete(message.id);\n\n      for (const item of message.result.result ?? []) {\n        // Force-fully format the properties description to be an empty string\n        if (item.value) {\n          item.value.description = item.value.description ?? '';\n        }\n\n        // Avoid passing the `objectId` for symbol types.\n        // When collapsing in vscode, it will fetch information about the symbol using the `objectId`.\n        // The `Runtime.getProperties` request of the symbol hard-crashes Hermes.\n        if (item.value?.type === 'symbol' && item.value.objectId) {\n          delete item.value.objectId;\n        }\n      }\n    }\n\n    // Do not block propagation of this message\n    return false;\n  }\n}\n\n/** @see https://chromedevtools.github.io/devtools-protocol/v8/Runtime/#method-getProperties */\nexport type RuntimeGetProperties = CdpMessage<\n  'Runtime.getProperties',\n  Protocol.Runtime.GetPropertiesRequest,\n  Protocol.Runtime.GetPropertiesResponse\n>;\n"],"names":["VscodeRuntimeGetPropertiesHandler","interceptGetProperties","Set","onDebuggerMessage","message","userAgent","getDebuggerType","method","add","id","onDeviceMessage","has","delete","item","result","value","description","type","objectId"],"mappings":"AAAA;;;;AASgC,IAAA,MAAS,WAAT,SAAS,CAAA;AAUlC,MAAMA,iCAAiC;IAC5C,kFAAkF,CAClFC,sBAAsB,GAAG,IAAIC,GAAG,EAAU,CAAC;IAE3CC,iBAAiB,CACfC,OAA8C,EAC9C,EAAEC,SAAS,CAAA,EAAoB,EACtB;QACT,IAAIC,CAAAA,GAAAA,MAAe,AAAW,CAAA,gBAAX,CAACD,SAAS,CAAC,KAAK,QAAQ,IAAID,OAAO,CAACG,MAAM,KAAK,uBAAuB,EAAE;YACzF,IAAI,CAACN,sBAAsB,CAACO,GAAG,CAACJ,OAAO,CAACK,EAAE,CAAC,CAAC;SAC7C;QAED,2CAA2C;QAC3C,OAAO,KAAK,CAAC;KACd;IAEDC,eAAe,CAACN,OAA6C,EAAE,EAAEC,SAAS,CAAA,EAAoB,EAAE;QAC9F,IACEC,CAAAA,GAAAA,MAAe,AAAW,CAAA,gBAAX,CAACD,SAAS,CAAC,KAAK,QAAQ,IACvC,IAAI,IAAID,OAAO,IACf,IAAI,CAACH,sBAAsB,CAACU,GAAG,CAACP,OAAO,CAACK,EAAE,CAAC,EAC3C;YACA,IAAI,CAACR,sBAAsB,CAACW,MAAM,CAACR,OAAO,CAACK,EAAE,CAAC,CAAC;gBAE5BL,OAAqB;YAAxC,KAAK,MAAMS,IAAI,IAAIT,CAAAA,OAAqB,GAArBA,OAAO,CAACU,MAAM,CAACA,MAAM,YAArBV,OAAqB,GAAI,EAAE,CAAE;oBAS1CS,GAAU;gBARd,sEAAsE;gBACtE,IAAIA,IAAI,CAACE,KAAK,EAAE;wBACWF,YAAsB;oBAA/CA,IAAI,CAACE,KAAK,CAACC,WAAW,GAAGH,CAAAA,YAAsB,GAAtBA,IAAI,CAACE,KAAK,CAACC,WAAW,YAAtBH,YAAsB,GAAI,EAAE,CAAC;iBACvD;gBAED,iDAAiD;gBACjD,8FAA8F;gBAC9F,yEAAyE;gBACzE,IAAIA,CAAAA,CAAAA,GAAU,GAAVA,IAAI,CAACE,KAAK,SAAM,GAAhBF,KAAAA,CAAgB,GAAhBA,GAAU,CAAEI,IAAI,CAAA,KAAK,QAAQ,IAAIJ,IAAI,CAACE,KAAK,CAACG,QAAQ,EAAE;oBACxD,OAAOL,IAAI,CAACE,KAAK,CAACG,QAAQ,CAAC;iBAC5B;aACF;SACF;QAED,2CAA2C;QAC3C,OAAO,KAAK,CAAC;KACd;CACF;QA1CYlB,iCAAiC,GAAjCA,iCAAiC"}